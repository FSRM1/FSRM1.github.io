<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title></title>
    <link href="/2023/08/18/%E6%97%A0%E5%8F%82%E6%95%B0RCE/"/>
    <url>/2023/08/18/%E6%97%A0%E5%8F%82%E6%95%B0RCE/</url>
    
    <content type="html"><![CDATA[<p>前言：</p><p>之前学这个命令执行的时候学的一塌糊涂 现在重新开始再学习一遍</p><p>来一个最基本的无参数rce的例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;;&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;code&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>上面的一个正则匹配就是如果匹配到了函数调用就替换成空</p><p>分开来说一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html">[^\W]  匹配到数字字母加下划线  <br>\(：匹配左括号 &quot;(&quot;。<br>(?R)?：递归匹配整个正则表达式。这是一个可选的子模式。   就是能够匹配到a(b(c())) 类似于这种的嵌套式的<br>\): 匹配右括号 &quot;)&quot;。<br><br>其实就是匹配到类似于aa()的话就会替换成空 然后if语句就会满足 就能执行eval函数<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;aa();&#x27;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$a</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span><br>    运行结果为：  ;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;aa(aa);&#x27;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$a</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span>   运行结果为：<span class="hljs-title function_ invoke__">aa</span>(aa);<br></code></pre></td></tr></table></figure><h1 id="无参数RCE"><a href="#无参数RCE" class="headerlink" title="无参数RCE"></a>无参数RCE</h1><h2 id="HTTP请求标头-（php7-3）"><a href="#HTTP请求标头-（php7-3）" class="headerlink" title="HTTP请求标头 （php7.3）"></a>HTTP请求标头 （php7.3）</h2><p>getallheaders() 获取所有http请求头</p><p>和bp抓包看到消息是反过来的</p><p>print_r()  是为了让http头显示出来  这里后面命令执行的话可以替换成eval函数等</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705163653278.png" alt="image-20230705163653278"></p><p>如上图所示</p><p>end() 获取最后一个 </p><p>pos() 获取第一个   上面的都是响应后的排序</p><p>然后这样我们就可以进行一个命令执行了 </p><p>如下图</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705164425152.png" alt="image-20230705164425152"></p><p><strong>apache_request_headers()</strong> 功能与getallheaders()相似 ，适用于Apache服务器</p><h2 id="利用全局变量进行RCE（php-5-7）"><a href="#利用全局变量进行RCE（php-5-7）" class="headerlink" title="利用全局变量进行RCE（php 5/7）"></a>利用全局变量进行RCE（php 5/7）</h2><p><strong>get_defined_vars()</strong> 返回所有已定义变量的值，所组成的数组</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705172356244.png" alt="image-20230705172356244"></p><p>然后我们可以利用pos()和end() 来拿到我们想要的</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705172528707.png" alt="image-20230705172528707"></p><p>在上面可以看到phpinfo()和code都在get下面 然后通过pos()可以得到get里面的值 再通过end()就可以得到phpinfo();了</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705172800147.png" alt="image-20230705172800147"></p><p>最后将前面的print_r改成eval函数即可</p><h2 id="利用session-（php5）"><a href="#利用session-（php5）" class="headerlink" title="利用session （php5）"></a>利用session （php5）</h2><p>可以利用eval进行命令执行 也可以利用show_source 读取源码</p><p>先来说一下这个session是怎么使用的 </p><p>当session_start()开启时为ture 此时用print_r() 打印出来的结果是1 然后可以查看session中的session_id 这个是可以控制的</p><p>如下图所示：</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705201754616.png" alt="image-20230705201754616"></p><p><strong>1.利用eval进行一个命令执行的话需要将你所要实现的东西进行16进制编码 然后再转换成2进制</strong></p><p>如下图：</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705202015374.png" alt="image-20230705202015374"></p><p><strong>2.利用show_source进行一个读取源码：</strong></p><p>这个id是一个路径</p><p>如下图所示：</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230705202330180.png" alt="image-20230705202330180"></p><h2 id="使用scandir-进行文件读取"><a href="#使用scandir-进行文件读取" class="headerlink" title="使用scandir()进行文件读取"></a>使用scandir()进行文件读取</h2><p>函数较多</p><table><thead><tr><th>scandir() —— 列出指定路径中的所有文件和目录(PHP5,PHP7,PHP8)  类似于 ls</th></tr></thead><tbody><tr><td>getcwd() ——&gt; 取得当<strong>前目工作目录</strong> （php4,5,7,8） //类似于pwd</td></tr><tr><td>current() ——&gt; 返回数组中的当前值 （php 4,5,7,8）  //类似于上面的pos()</td></tr><tr><td>array_reverse() ——&gt; 返回单元顺序相反的数组（4，5，7，8）//将显示的文件名倒序排列 比如说 原本是1，2，3 使用array_reverse()后是 3，2，1</td></tr><tr><td>array_flip()——&gt; 交换数组中的键和值 （4，5，7，8）//一般和array_rand联系起来</td></tr><tr><td>next()——将数组中的内部指针向前移动 4，5，7，8  //如果说current()是读第一个 next就是读第二个</td></tr><tr><td>array_rand —— 从数组中随机取出一个或多个随机值  //这个只返回键名</td></tr><tr><td>chdir() 系统调用函数（同cd） 用于改变当前工作目录</td></tr><tr><td>strrev() —— 用于反转给定的字符串</td></tr><tr><td>crypt() 用来加密 目前linux平台上加密的方式大致有MD5,DES,3 DES</td></tr><tr><td>hebrevc() 把希伯来文本从右至左的流抓换为从左至右的流</td></tr><tr><td>localeconv() 显示当前目录文件名</td></tr><tr><td>dirname()上一级目录 相当于cd ..</td></tr><tr><td>ord()编码 chr()解码 只对第一个进行一个编解码 然后与crypt()和strrev() 结合 可以读取根目录下的文件</td></tr></tbody></table><p>上面的忘了的话可以实践一下看看具体效果</p><p><strong>查看上一级目录可以利用getcwd()  当利用getcwd()查看上一级目录时 如果想要读取上一级目录里面的一个文件时 是不能够成功的 因为show_source读取的是当前所在的目录 我们还没有切换到上一级目录 所以要利用到chdir()切换一下</strong></p><p>当我们想要读取的文件在中间时 要把array_flip() 和array_rand() 结合起来 可以进行任意读取  随机的话可以利用burp进行一个暴力破解</p><p><strong>想要读取根目录下的文件的话首先 利用array() 进行一个序列化 然后利用crypt()进行一个加密 如果出现了/ 但是出现在尾部 利用strrev() 进行一个反转 接着利用ord()和chr() 对第一个字符进行16进制编码和解码 最后可以利用scandir() 读取根目录下的文件名</strong></p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230706174622700.png" alt="image-20230706174622700"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>php反序列化逃逸</title>
    <link href="/2023/08/03/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/"/>
    <url>/2023/08/03/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/</url>
    
    <content type="html"><![CDATA[<p>之前就对字符串逃逸这一块理解的不是很深刻，下面通过一位师傅的博客来进一步深入理解一下有关php字符串逃逸的相关内容。</p><p>贴上师傅的博客地址:<a href="https://blog.csdn.net/qq_45521281/article/details/107135706%E3%80%81">https://blog.csdn.net/qq_45521281/article/details/107135706、</a></p><p><strong>先来说一下什么是字符串逃逸，就是我们可以构造一些恶意代码，让其在反序列化的时候执行我们想让它执行的。在这过程中造成的字符串的增加或者减少称为字符串逃逸。</strong></p><h1 id="替换修改后导致字符串长度增加-逃逸增加"><a href="#替换修改后导致字符串长度增加-逃逸增加" class="headerlink" title="替换修改后导致字符串长度增加   (逃逸增加)"></a>替换修改后导致字符串长度增加   (逃逸增加)</h1><p>先来一个代码简单的分析一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;bb&#x27;</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;aaaa&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;123456&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$AA</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>).<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$res</span>=<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>));<br><span class="hljs-variable">$c</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$res</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>-&gt;pass;<br><span class="hljs-meta">?&gt;</span><br>    看它的返回结果：<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;aaaa&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;pass&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;123456&quot;</span>;&#125;<br><span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><p>若我们在不直接修改pass的前提下，让pass的值变成hacker，我们该如何实现呢？<br>这里我们就用到了字符串逃逸增加来实现。</p><p>我们可以看到str_replace(‘bb’,’ccc’,$str); 意思就是在变量str中，将每两个b替换成三个c，但序列化之后的字符长度仍然按照没有被替换的。</p><p>举个例子说明一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;bb&#x27;</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;aaaabb&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;123456&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$AA</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>).<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$res</span>=<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$res</span>;<br><span class="hljs-meta">?&gt;</span><br>    运行的结果如下：<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;aaaabb&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;pass&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;123456&quot;</span>;&#125;<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;aaaaccc&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;pass&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;123456&quot;</span>;&#125;  <span class="hljs-comment">//这里我们可以看到aaaaccc明明是7个字符，但前面标的仍然是6个，这里就逃逸出来一个字符。</span><br></code></pre></td></tr></table></figure><p>根据上面的演示，我们可以进行构造代码，通过bb替换成ccc，来进行字符串的逃逸，从而让pass的值为hacker</p><p>下面是代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;bb&#x27;</span>,<span class="hljs-string">&#x27;ccc&#x27;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;;s:4:&quot;pass&quot;;s:6:&quot;hacker&quot;;&#125;&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;123456&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$AA</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>).<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$res</span>=<span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$AA</span>));<br><span class="hljs-variable">$c</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$res</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>-&gt;pass;<br><span class="hljs-comment">//echo $res;</span><br><span class="hljs-meta">?&gt;</span><br>    运行的结果：<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">81</span>:<span class="hljs-string">&quot;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;pass&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;hacker&quot;</span>;&#125;<span class="hljs-string">&quot;;s:4:&quot;</span>pass<span class="hljs-string">&quot;;s:6:&quot;</span><span class="hljs-number">123456</span><span class="hljs-string">&quot;;&#125;</span><br><span class="hljs-string">hacker</span><br><span class="hljs-string">成功的实现目标。</span><br></code></pre></td></tr></table></figure><p>思想就是我们要逃逸出来的字符串是”;s:4:”pass”;s:6:”hacker”;} 总共27个字符串，也就是说需要逃逸27个字符串出来，之前是2b逃逸出来一个，那么这需要逃逸27个，也就需要54b。</p><h1 id="替换修改后导致字符串长度减少-（逃逸减少）"><a href="#替换修改后导致字符串长度减少-（逃逸减少）" class="headerlink" title="替换修改后导致字符串长度减少  （逃逸减少）"></a>替换修改后导致字符串长度减少  （逃逸减少）</h1><p>字符串逃逸减少就是字符串经过一些变化后，字符长度减少，原来的功能性代码变成普通的字符串，然后我们可以利用逃逸进行构造一些恶意的代码。</p><p>下面来一个例子看一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str_rep</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/php|test/&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$string</span>);<br>&#125;<br><span class="hljs-variable">$test</span>[<span class="hljs-string">&#x27;name&#x27;</span>]=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable">$test</span>[<span class="hljs-string">&#x27;sign&#x27;</span>]=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;sign&#x27;</span>];<br><span class="hljs-variable">$test</span>[<span class="hljs-string">&#x27;number&#x27;</span>]=<span class="hljs-string">&#x27;2020&#x27;</span>;<br><span class="hljs-variable">$temp</span>=<span class="hljs-title function_ invoke__">str_rep</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$test</span>));<br><span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-variable">$temp</span>);<br><span class="hljs-variable">$fake</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$temp</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;<br><span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;name:&quot;</span>.<span class="hljs-variable">$fake</span>[<span class="hljs-string">&#x27;name&#x27;</span>].<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>);<br><span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;sign:&quot;</span>.<span class="hljs-variable">$fake</span>[<span class="hljs-string">&#x27;sign&#x27;</span>].<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>);<br><span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;number:&quot;</span>.<span class="hljs-variable">$fake</span>[<span class="hljs-string">&#x27;number&#x27;</span>].<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>代码都是上面师傅里面演示的，这里我是根据自己的理解来讲一下。</p><p>把这段代码放在本地，可以看到结果为：</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230523212438734.png" alt="image-20230523212438734"></p><p>这里可以看到name和sign里面都是没有内容的，所以这里是N。</p><p>然后我们看到代码中的str_rep()函数，是将变量string中的php和test替换成空。</p><p>然后下面有一个经过这段函数的反序列化，这里就构成了反序列化逃逸减少的漏洞。</p><p>反序列化逃逸减少不同于增加。</p><p>增加是看要构造的恶意代码字符串长度是多少，就举一个例子，如果匹配到了bb,函数是把它替换成ccc，那么就相当于每一个bb可以逃逸出1个字符，如果我们要构造的恶意代码长度是27位，那么我们就需要54个bb。</p><p>而减少我个人感觉是比增加复杂一点，但也不多。拿上面的代码进行演示，如果我想让sign的值是eval，并且数字改成2023，那么这就利用到了字符串逃逸减少。</p><p>首先构造我们要实现的目标。”;s:4:”sign”;s:4:”eval”;s:6:”number”;s:4:”2023”;}  </p><p>减少逃逸是让一些功能性代码变成字符串，这里是让sign变成字符串，而后面构造的sign和number则成为新的功能性代码。</p><p>“;s:4:”sign”;s:xx:”前面的字符一共有19个，我们有两种方法，一种是利用php，另外一种是利用test只不过都需要填充字符罢了   “;s:4:”sign”;s:4:”eval”;s:6:”number”;s:4:”2023”;} </p><p>“;s:4:”sign”;s:xx:”这里是需要填充的字符”;s:4:”sign”;s:4:”eval”;s:6:”number”;s:4:”2023”;} </p><p>如果用7个php，也就是可以逃逸21个，上面是19个，那么我们可以填充2个字符。</p><p>如果用5个test,逃逸20个，需要填充一个字符。</p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230523220202942.png" alt="image-20230523220202942"></p><p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230523220226399.png" alt="image-20230523220226399"></p><p>结果如上。</p>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
